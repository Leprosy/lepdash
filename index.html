<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>hello phaser!</title>
        <script src="js/phaser.js"></script>
    </head>
    <body>

    <script type="text/javascript">
    //Utils
    function createGround(width, height){
        var result = [];
        for (var i = 0 ; i < width; i++) {
            result[i] = [];
            for (var j = 0; j < height; j++) {
                var item = 0;

                if (!(i == 0 && j == 0)) {
                    var chance = Math.random() * 100;
                    //if (chance > 90) item = Game.ROCK;
                    //else if (chance > 85) item = Game.DIAMOND;
                    //else if (chance > 80) item = Game.WALL;
                    //else if (chance > 40) item = Game.DIRT;
                    if (chance > 95) item = Game.ROCK;
                    else if (chance > 80) item = Game.DIRT;
                }

                result[i][j] = item;
            }
        }
        return result;
    }

    // Namespace and basic parameters
    var Game = {};
    Game.DIRT = 2;
    Game.DIRT2 = 3;
    Game.WALL = 1;
    Game.ROCK = 4;
    Game.DIAMOND = 5;

    Game.vars = {};
    Game.vars.size = 32;
    Game.vars.speed = 500;
    Game.vars.score = 0;
    Game.vars.lives = 3;
    Game.vars.level = 0;

    //JSON this!
    Game.map = createGround(15, 15);
    Game.spriteMap = createGround(15, 15);
    console.log(Game.map)


    // Entry point
    window.onload = function() {
        Game.base = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

        function preload () {
            Game.base.load.image('bg', 'img/bg0.png');
            Game.base.load.spritesheet('sprites', 'img/sprites.png', Game.vars.size, Game.vars.size);
        }

        function create () {
            this.updateTime = this.time.now + Game.vars.speed;
            this.tapTime = this.time.now + Game.vars.speed * 50;
            _setSpeed();
            _setBG();
            _setMap();
            _setActors();
            Game.cursors = Game.base.input.keyboard.createCursorKeys();
            Game.player.animations.play("still");
        }

        function _setMap() {
            for (i in Game.map) {
                var row = Game.map[i]

                for(j in row) {
                    if (row[j] != 0) {
                        var sprite = Game.base.add.sprite(Game.vars.size * i, Game.vars.size * j, 'sprites');
                        Game.spriteMap[i][j] = sprite;

                        // Special map things
                        if (row[j] == Game.DIAMOND) {
                            sprite.animations.add("be", [40, 50, 60, 70, 41, 51, 61, 71], 10, true);
                            sprite.animations.play("be");
                        } else { // Everything else
                            sprite.frame = 31 + row[j];
                        }
                    }
                }
            }
        }

        function _setSpeed() {
            /*Game.base.time.advancedTiming = true;
            Game.base.time.desiredFps = 60;*/
            /* Game.base.time.desiredFps = 120;
            Game.base.time.slowMotion = 10 // 10.0; */
        }

        function _setBG() {
            Game.bg = Game.base.add.sprite(Game.base.world.centerX, Game.base.world.centerY, 'bg');
            Game.bg.anchor.setTo(0.5, 0.5);
        }

        function _setActors() {
            Game.player = Game.base.add.sprite(0, 0, 'sprites');
            Game.player.animations.add('left', [10, 11, 12, 13, 14, 15, 16], 20, false);
            Game.player.animations.add('right', [20, 21, 22, 23, 24, 25, 26], 20, false);
            Game.player.animations.add('up', [10, 11, 12, 13, 14, 15, 16], 20, false);
            Game.player.animations.add('down', [20, 21, 22, 23, 24, 25, 26], 20, false);
            Game.player.animations.add('still', [0], 10, false);
            Game.player.animations.add('blink', [0, 1, 2, 1], 10, false).onComplete.add(function() {
                Game.player.animations.play("still");
            });
            Game.player.animations.add('tap', [3, 4, 3, 4, 5, 6, 5, 4, 3, 4, 3, 4, 5, 6, 5, 4], 10, false).onComplete.add(function() {
                Game.player.animations.play("still");
            });
        }

        function _checkMap(x, y) {
            x = x / Game.vars.size;
            y = y / Game.vars.size;

            // Border
            if (x >= 0 && y >= 0 && x < Game.map.length && y < Game.map[0].length) {
                // Elements in map
                if (Game.map[x][y] != Game.WALL && Game.map[x][y] != Game.ROCK) {
                    //Check if dirt or item
                    if (Game.map[x][y] == Game.DIRT) {
                        Game.map[x][y] = 0;
                        Game.spriteMap[x][y].destroy();
                    }
                    if (Game.map[x][y] == Game.DIAMOND) {
                        Game.map[x][y] = 0;
                        Game.spriteMap[x][y].destroy();
                        Game.vars.score++;
                    }

                    return true;
                }

                return false;
            }

            return false;
        }

        function _checkKeys(parent) {
            if (Game.cursors.left.isDown) {
                if (_checkMap(Game.player.x - Game.vars.size, Game.player.y)) Game.player.x -= Game.vars.size;
                Game.player.animations.play('left');
                parent.tapTime = parent.time.now + Game.vars.speed * 50;
            } else if (Game.cursors.right.isDown) {
                if (_checkMap(Game.player.x + Game.vars.size, Game.player.y)) Game.player.x += Game.vars.size;
                Game.player.animations.play('right');
                parent.tapTime = parent.time.now + Game.vars.speed * 50;
            } else if (Game.cursors.up.isDown) {
                if (_checkMap(Game.player.x, Game.player.y - Game.vars.size)) Game.player.y -= Game.vars.size;
                Game.player.animations.play('left');
                parent.tapTime = parent.time.now + Game.vars.speed * 50;
            } else if (Game.cursors.down.isDown) {
                if (_checkMap(Game.player.x, Game.player.y + Game.vars.size)) Game.player.y += Game.vars.size;
                Game.player.animations.play('right');
                parent.tapTime = parent.time.now + Game.vars.speed * 50;
            } else {
                if (Game.player.animations.currentAnim.isFinished) {
                    if (parent.tapTime < parent.time.now) {
                        parent.tapTime = parent.time.now + Game.vars.speed * 50;
                        Game.player.animations.play("tap");
                    } else if (Math.random() * 10 > 9.5) {
                        Game.player.animations.play("blink");
                    } else {
                        Game.player.animations.play("still");
                    }
                }
            }
        }

        function _checkGravity(parent) {
            for (i = 0; i < Game.map.length; ++i) {
                var row = Game.map[i];

                for (j = row.length - 2; j >= 0; --j) {
                    if (Game.map[i][j] == Game.ROCK && Game.map[i][j + 1] == 0) {
                        console.log("lpok", i, j)
                        Game.map[i][j] = 0;
                        Game.map[i][j + 1] = Game.ROCK;

                        Game.spriteMap[i][j].y += Game.vars.size;
                        Game.spriteMap[i][j + 1] = Game.spriteMap[i][j];
                        Game.spriteMap[i][j] = 0;
                    }
                }
            }
        }

        function update() {
            if (this.updateTime < this.time.now) {
                _checkKeys(this);
                _checkGravity(this);
                this.updateTime = this.time.now + Game.vars.speed;
            }
        }
    };
    </script>

    </body>
</html>